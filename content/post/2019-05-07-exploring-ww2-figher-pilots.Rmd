---
title: 'World War II Flying Aces - Exploratory data analysis packages/techniques (part 2)'
author: Martin Frigaard
date: '2019-05-07'
slug: exploring-ww2-figher-pilots
categories:
  - R
  - How-To
tags:
  - tidyverse
description: 'This is a continuation of my previous post on WW2 fighter pilots.'
topics: []
---


```{r knitr_init, echo=FALSE, cache=FALSE, include=FALSE}
library(knitr)
library(rmdformats)
library(tidyverse)
library(magrittr)
## Global options
options(max.print = "75")
# images folder
if (!file.exists("images")) {
  dir.create("images")
}
opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  prompt = FALSE,
  tidy = FALSE,
  comment = "",
  message = FALSE,
  warning = FALSE,
  size = "vsmall",
  fig.path = "images/"
)
knitr::opts_knit$set(
  width = 78
)
base::options(
  tibble.print_max = 25,
  tibble.width = 78
)
options(scipen = 100000000)
```

## The WW2 fighter pilot data

These data come from the Wikipedia page [here](https://en.wikipedia.org/wiki/List_of_World_War_II_flying_aces), and I went over downloading these data in my previous [post](https://www.martinfrigaard.io/post/ww2-fighter-pilots-scraping-html-tables/).

In this post, I'll be covering some data wrangling and manipulation with the `tidyverse`. I will also be using the `janitor`, `inspectdf`, and `ggplot2` packages. 

### Load the packages 

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(inspectdf)
library(janitor)
```

## Download data

The data from the previous post have been stored in a Github repo [here](https://github.com/mjfrigaard/cloud-projects/blob/master/Data/2019-05-03-WW2AcesRAW.csv). 

Before downloading these data, I'll create a `data` folder to store them. 

```{r data-folder}
if (!file.exists("data")) {
  dir.create("data")
}
```

Now I can download these data into the `data` folder. 

```{r download}
utils::download.file(
  url = "http://bit.ly/2Lo079B",
  destfile = "data/2019-05-03-WW2AcesRaw.csv"
)
# verify
fs::dir_ls("data")
```


## Import data

Now I can read these data into R using the `readr::read_csv()` function.

```{r load-WW2AcesRaw, message=FALSE, warning=FALSE}
WW2AcesRaw <- readr::read_csv("data/2019-05-03-WW2AcesRaw.csv")
WW2AcesRaw %>% dplyr::glimpse(78)
```

These data are raw (meaning unaltered), so I will do some wrangling to make them easier to manage. 

### Clean up the variable names

The variable names are not formatted in a way that makes life easy in R--too many spaces, upper and lowercase letters, and parentheses. The first thing I like to do is clean up their names with `janitor::clean_names()`

```{r WW2Aces}
WW2Aces <- WW2AcesRaw %>%
  janitor::clean_names(dat = ., case = "snake")
WW2Aces %>% dplyr::glimpse()
```

## Check for missing data

To identify where the missing data are in the `WW2Aces` dataset, I can use the `inspectdf::inspect_na` package to identify the missing data. 

```{r install-inspectdf, eval=FALSE}
inspectdf::inspect_na(WW2Aces, show_plot = TRUE)
```

![inspectdf version 1](/post/2019-05-07-exploring-ww2-figher-pilots_files/install-inspectdf-1.png){width=100%}

```{r install-inspectdf-2, echo=FALSE}
inspectdf::inspect_na(WW2Aces)
```

This is showing me that the majority of missing values are in the `other_aerial_victories` and `notes` variables. The `air_vic_num` also has a few missing observations, but it's not clear why. 

But, this variable should be complete for everyone in the `WW2Aces` table because, after all, this *is* a list of WW2 flying aces, which by definition have been ["*credited with shooting down several enemy aircraft during aerial combat*"](https://en.wikipedia.org/wiki/Flying_ace). This warrants a little more investigation...

## Convert aerial victories to a numerical variable

The `aerial_victories` variable needs to be numeric so we can perform math operations on it (means, sums, etc.). This can be accomplished with `dplyr::mutate()`. 

```{r as-numeric-aerial_victories}
# test
WW2Aces <- WW2Aces %>%
  dplyr::mutate(air_vic = as.numeric(aerial_victories))
```

The warning `NAs introduced by coercion` tells me some `NA`s values were created in this variable when I converted it to numeric. But I want to know *which* observations ended up with `NA` values, and why.

I can visually inspect these with some `filter()`ing...

```{r check-mutate-numeric}
WW2Aces %>%
  dplyr::filter(is.na(air_vic)) %>% 
  dplyr::select(name, aerial_victories) %>%
  dplyr::sample_frac(size = 0.10) 
```

A-HA! Now I can see what the problem is--there were character symbols (`½`, `¼`, etc) not being identified correctly (i.e. `0.5` and `0.25`) in the `dplyr::mutate()` function. 

I can fix these values with a few `stringr::str_replace_all()` calls. I typically just keep adding the pattern incrementally until I do not see the warning anymore. 

```{r wrangle-arial-victories}
WW2Aces <- WW2Aces %>%
  dplyr::mutate(
    # replace 2/3
    air_vic = stringr::str_replace_all(
      string = aerial_victories,
      pattern = "¾",
      replacement = ".66"),
    # replace 1/2
    air_vic = stringr::str_replace_all(
      string = air_vic,
      pattern = "½",
      replacement = ".50"),
    # replace 1/3
    air_vic = stringr::str_replace_all(
      string = air_vic,
      pattern = "⅓",
      replacement = ".33"),
    # replace 1/4
    air_vic = stringr::str_replace_all(
      string = air_vic,
      pattern = "¼",
      replacement = ".25"),
    # get rid of the random . with a space in front of it
    air_vic = stringr::str_replace_all(
      string = air_vic,
      pattern = " .",
      replacement = "."),
    # remove the +
    air_vic = stringr::str_remove_all(
      string = air_vic,
      pattern = "\\+"),
    # convert this to numeric
    air_vic = as.numeric(air_vic)) %>%

  # reorganize the variables and give better names
  dplyr::select(name,
                
    service = service_s,
    air_vic,
    air_vic_chr = aerial_victories,
    air_vic_oth = other_aerial_victories,
    dplyr::everything())
# check dataframe
WW2Aces %>% glimpse(78)
```


Now I can recheck the missing observations with `inspectdf::inspect_na()` again.

```{r inspect_na-again, eval=FALSE}
inspectdf::inspect_na(WW2Aces, show_plot = TRUE)
```


```{r inspect_na-again-2, echo=FALSE}
inspectdf::inspect_na(WW2Aces)
```

![](/post/2019-05-07-exploring-ww2-figher-pilots_files/inspect_na-again-1.png){width=100%}

This shows that the `air_vic` variable now has zero missing values. 

### Identify KIA, MIA, Died of wounds, etc.

If I look in the `name` data, I see there is another special character (`†`). There is some additional information on the pilots from the [wikipedia page](https://en.wikipedia.org/wiki/List_of_World_War_II_flying_aces),

> "This background, along with the symbol "†", indicates that the pilot was killed in action, missing in action, died of wounds, or was killed in a flying accident during World War II."

So I can use `stringr::str_detect()` to find the `†` character, then use `dplyr::case_when()` to create an indicator for this designation `mia_or_kia`.

```{r wrangle-vars, message=FALSE, warning=FALSE}
WW2Aces <- WW2Aces %>%
  dplyr::mutate(
    # create indicator for missing in action/killed/etc.
    mia_or_kia = dplyr::case_when(
      # now create the conditions
      stringr::str_detect(
        string = name,
        # condition 1
        pattern = "†") ~ "KIA, MIA, Died of wounds",
      # condition 2
      TRUE ~ "Lived"))
WW2Aces %>% dplyr::count(mia_or_kia)
```

I will use the `inspectdf::inspect_imb()` function to example the entire data frame below. 

```{r inspect_imb, eval=FALSE}
inspectdf::inspect_imb(WW2Aces, show_plot = TRUE)
```

```{r inspect_imb-2, echo=FALSE}
inspectdf::inspect_imb(WW2Aces)
```

This table contains the following:

* `col_name` character vector containing column names

* `value` character vector containing the most common categorical level in each column

* `pcnt` the percentage of each column's entries occupied by the level in value column

* `cnt` the number of occurrences of the most common categorical level in each column


![](/post/2019-05-07-exploring-ww2-figher-pilots_files/inspect_imb-1.png){width=100%}


Enter `?inspect_imb` in the console for more information on this function. I use these function a lot for viewing and comparing datasets.

## Who fought for which side?

I wanted a variable to categorize what side each country was on, Axis or Allied forces. The `WW2Aces` data are organized by the name of each pilot, but I can use their `country` to create a variable that categorizes the data into two groups (or `force`s):

1. The primary `Axis` consisted of Germany, Croatia, Japan, Romania, Slovak Republic, Hungary, and Italy.

2. The primary `Allied` forces were the United States, the Soviet Union, France, United Kingdom, Australia, Canada, Ireland, Mexico, China, Indonesia, India, New Zealand, Rhodesia, South Africa, Sweden, Yugoslavia, French Indochina, Lithuania, Czechoslovakia, Greece, Burma, and Latvia. 

I can put these into two regular expressions (`axis_regex`, `allied_regex`), and use these to create a new variable (`force`) with `dplyr::case_when()`. 

#### A few thoughts on the `force` categories

There were countries who couldn't easily be placed into the `force` variable, so I've included my thought process behind their categorization below:

+ [Bulgaria](https://en.wikipedia.org/wiki/Military_history_of_Bulgaria_during_World_War_II) was neutral in the beginning of the war (1939-1941), then aligned with the Axis powers (1941-1944), only to finally sign with the Allied forces in the last year of the war (1944-1945). I categorized them into the `Axis` group because it's where they spent the majority of their time during the war

+ [Finland](https://en.wikipedia.org/wiki/Military_history_of_Finland_during_World_War_II) was in a similar situation--they fought against the Soviet Union in 1939-1940, and again with the Axis 1941-1944. They ended up having expelling Nazi forces from their country in 1945. I put them in the `Axis` group because they spent the majority of the war on the `Axis` side. 

+ [Iceland](https://en.wikipedia.org/wiki/Iceland_in_World_War_II) was technically neutral, and the United States was responsible for the countries defense starting in 1941. I listed them as part of the `Allied` forces because of the US Marine forces who were stationed there until 1942. In 1944, Iceland became it's own republic. 

+ [Norway, Belgium, Czechoslovakia, Netherlands, and Poland](https://en.wikipedia.org/wiki/Allied_Forces_Act_1940) all signed the Allied forces Act of 1940, which allowed them to "raise, equip and maintain independent armed forces on British soil." All of these countries were included in the `Allied` forces. 

+ [German immigrants in Brazil](https://en.wikipedia.org/wiki/Nazism_in_Brazil) were involved with the Nazi party before World War II. There was almost 90,000 German immigrants in Brazil after World War I, although only a small portion were affiliated with the Nazi party. Brazil is not listed in the `country` variable, but `Nazi Germany/ Brazil` is, and it's listed in `Axis` forces. 


```{r axis-allied}
axis <- c("Germany", "Bulgaria", "Croatia", "Finland", "Japan", "Romania",
  "Slovak Republic", "Hungary", "Italy", "Brazil")

axis_regex <- paste0(axis, collapse = "|")

allied <- c("Australia", "Belgium", "Canada", "Iceland", "Ireland", "Mexico",
  "Soviet Union", "China", "Poland", "Indonesia", "India", "New Zealand", 
  "Norway", "Rhodesia", "South Africa", "Sweden", "Yugoslavia", 
  "French Indochina", "France", "United Kingdom", "United States", "Lithuania",
  "Czechoslovakia", "Greece", "Burma", "Latvia")
allied_regex <- paste0(allied, collapse = "|")
```


The `dplyr::case_when()` statement comes in handy if you need to create a new categorical variable. It can handle any argument that evaluates to `TRUE` or `FALSE`, which means there a ton of options for defining categories. Below I use the `stringr::str_detect()` function to identify the Axis and Allied countries I've stored in the `regex` vectors I created above.

I also like to visually inspect new categorical variables with `tidyr::spread()`.

```{r force}
WW2Aces <- WW2Aces %>%
  dplyr::mutate(force = dplyr::case_when(
    str_detect(string = country, pattern = axis_regex) ~ "Axis",
    str_detect(string = country, pattern = allied_regex) ~ "Allied")) 
# verify this with tidyr
WW2Aces %>% 
    dplyr::count(force, country) %>% 
    tidyr::spread(force, n)
```

## What was the average number of aerial victories by country and force?

Now I can group by these two variables and calculate the average number of aerial victories by `force` and `country`. I'll use the `ggthemes::theme_wsj()` function because it makes the graph look like it was typed and created on old paper. 

```{r aerial-victories-by-force-country, results='hide', eval=FALSE}
WW2Aces %>%
    # group by the two variables of interest
  dplyr::group_by(force, country) %>%
   # get the measurement I am insterested in
  dplyr::summarise(mean_air_vic = mean(air_vic, na.rm = TRUE)) %>%
    # put the new variable on the X
  ggplot2::ggplot(aes(x = mean_air_vic,
                      # wrangle the country variable in the plot function
                      y = forcats::fct_reorder(.f = country,
                                               .x = force),
                      # add group aesthetic here
                      group = force)) +
    # start this line at the country (on the y)
    ggplot2::geom_segment(aes(yend = country), 
                          # end at 0 on the X
                 xend = 0, 
                 
                 color = "grey50") +
    # add points and color by the force variable
    ggplot2::geom_point(size = 2.3, aes(color = force)) +
    
    # this is for the legend on the graph
    ggplot2::scale_colour_brewer(palette = "Set1", 
                                 limits = c("Axis", "Allied")) + 
    # reduce clutter
    ggthemes::theme_wsj(base_size = 9, 
                        base_family = "Andale Mono",
                        color = 'brown', 
                        title_family = "Courier New") +
    
    # ggplot2::theme(axis.title = element_text(size = 9)) +
    
    # add labs
    ggplot2::labs(x = "Average Arial victories",
                y = "Country/Service",
               title = "Aerial victories in WW2") +
    
    ggplot2::theme(axis.text.x = element_text(size = 7.5),
                   axis.text.y = element_text(size = 7.5),
                   axis.title.x = element_text(size = 10),
                   axis.title.y = element_text(size = 10),
                   axis.title = element_text(size = 9))
```

![This is a Cleveland dot plot](/post/2019-05-07-exploring-ww2-figher-pilots_files/aerial-victories-by-force-country-1.png){width=100%}

It looks like the `German` pilots had the highest average number of aerial victories overall, followed by the `Soviet Union` on the `Allied` side. In my next post I will dig more into the variation across countries and pilots. 